<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Wordpress to JBake - Parseo | AguasNegras</title><meta name=keywords content="Java,JBake,Wordpress"><meta name=description content="Pues ahora que ya tengo el constructor y construyo un objeto siempre que, al menos es coherente, toca parsear el xml para extraer los datos. En Java, esencialmente hay tres formas de parsear xml, todas dentro de lo que se denomina Java XML Processing API, JAXP:
SAX: La API originaria, orientada a eventos. Muy rápida, muy eficiente y muy farragosa. Técnicamente es una API de streaming mediante push, es decir, nosotros arrancamos el procesamiento del documento y la API empieza a funcionar mandándonos eventos conforme va encontrando elementos."><meta name=author content="Agustín Ventura Carrasco"><link rel=canonical href=https://www.aguasnegras.es/posts/2016/03/20-wp2jbake-parseo/><meta name=google-site-verification content="G-W84F3CSJ3P"><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.aguasnegras.es/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.aguasnegras.es/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://www.aguasnegras.es/favicon.ico><link rel=apple-touch-icon href=https://www.aguasnegras.es/favicon.ico><link rel=mask-icon href=https://www.aguasnegras.es/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-W84F3CSJ3P"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W84F3CSJ3P",{anonymize_ip:!1})}</script><meta property="og:title" content="Wordpress to JBake - Parseo"><meta property="og:description" content="Pues ahora que ya tengo el constructor y construyo un objeto siempre que, al menos es coherente, toca parsear el xml para extraer los datos. En Java, esencialmente hay tres formas de parsear xml, todas dentro de lo que se denomina Java XML Processing API, JAXP:
SAX: La API originaria, orientada a eventos. Muy rápida, muy eficiente y muy farragosa. Técnicamente es una API de streaming mediante push, es decir, nosotros arrancamos el procesamiento del documento y la API empieza a funcionar mandándonos eventos conforme va encontrando elementos."><meta property="og:type" content="article"><meta property="og:url" content="https://www.aguasnegras.es/posts/2016/03/20-wp2jbake-parseo/"><meta property="og:image" content="https://www.aguasnegras.es/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-03-20T00:00:00+00:00"><meta property="article:modified_time" content="2016-03-20T00:00:00+00:00"><meta property="og:site_name" content="AguasNegras"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.aguasnegras.es/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Wordpress to JBake - Parseo"><meta name=twitter:description content="Pues ahora que ya tengo el constructor y construyo un objeto siempre que, al menos es coherente, toca parsear el xml para extraer los datos. En Java, esencialmente hay tres formas de parsear xml, todas dentro de lo que se denomina Java XML Processing API, JAXP:
SAX: La API originaria, orientada a eventos. Muy rápida, muy eficiente y muy farragosa. Técnicamente es una API de streaming mediante push, es decir, nosotros arrancamos el procesamiento del documento y la API empieza a funcionar mandándonos eventos conforme va encontrando elementos."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.aguasnegras.es/posts/"},{"@type":"ListItem","position":2,"name":"Wordpress to JBake - Parseo","item":"https://www.aguasnegras.es/posts/2016/03/20-wp2jbake-parseo/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Wordpress to JBake - Parseo","name":"Wordpress to JBake - Parseo","description":"Pues ahora que ya tengo el constructor y construyo un objeto siempre que, al menos es coherente, toca parsear el xml para extraer los datos. En Java, esencialmente hay tres formas de parsear xml, todas dentro de lo que se denomina Java XML Processing API, JAXP:\nSAX: La API originaria, orientada a eventos. Muy rápida, muy eficiente y muy farragosa. Técnicamente es una API de streaming mediante push, es decir, nosotros arrancamos el procesamiento del documento y la API empieza a funcionar mandándonos eventos conforme va encontrando elementos.","keywords":["Java","JBake","Wordpress"],"articleBody":"Pues ahora que ya tengo el constructor y construyo un objeto siempre que, al menos es coherente, toca parsear el xml para extraer los datos. En Java, esencialmente hay tres formas de parsear xml, todas dentro de lo que se denomina Java XML Processing API, JAXP:\nSAX: La API originaria, orientada a eventos. Muy rápida, muy eficiente y muy farragosa. Técnicamente es una API de streaming mediante push, es decir, nosotros arrancamos el procesamiento del documento y la API empieza a funcionar mandándonos eventos conforme va encontrando elementos. DOM: La API orientada a objetos, representa el XML como un árbol en memoria. Muy fácil de acceder, muy tragón de recursos. Técnicamente, se representa el árbol del DOM en memoria y listo, se puede acceder libremente, por ejemplo usando XPath. StAX: A partir del JDK 1.5 se encuentra disponible esta API que es un modelo mixto, se basa en un modelo de streaming (parecido a SAX) pero más sencillo de utilizar y además permite escribir. Técnicamente se define como una API de streming mediante pull, es decir, que somos nosotros los que vamos indicanto los elementos que queremos acceder. Eso sí, al ser de streaming solo permite avanzar en el documento, es decir, no podemos ignorar el elemento 1, tratar el 2 y en función de este retroceder a tratar el 1. En mi caso en particular, y dado que el modelo de “ir hacia delante” se adapta perfectamente al caso de uso (ya que simplemente estoy emparejando), pero tampoco necesito tantísima eficiencia ni tengo ganas de fastidiarme la vida, voy a utilizar StAX.\nPero lo primero, ahora que tengo que trabajar “en serio” es utilizar datos de verdad para las pruebas. Para eso hay dos opciones:\nGuardo un XML de pruebas en forma de un String en un archivo .java y lo leo de ahí. Guardo un archivo XML como tal. Pues como que la primera opción es una tontería, he optado por la segunda. He sacado la exportación de datos que proporciona Wordpress y he dejado unos cuantos posts que sean más o menos representativos y listo. Lo guardo en src/resources/wp-source.xml. Antes de seguir, ya no tiene sentido que los tests sigan usando el pom.xml para las pruebas, así que lo cambio y lo lanzo. Todo en verde, como cabía esperar.\nAhora bien, ya tengo mi objeto de la clase Wp2JBake creado con el origen y el destino debidamente especificado, ¿como arranco el procesamiento? Hay que tener en cuenta que realmente el método de proceso no tiene por qué devolver nada, ya que el resultado efectivo de la salida es una estructura de archivos con el resultado de la conversión. Sin embargo, creo que es “gratis” devolver los elementos que se han generado y así se posibilita poder comprobar el resultado de la generación.\nAsí que primero el test:\n@Test public void processEmptyXML() { sut = new Wp2JBake(\"src/test/resources/empty.xml\", \"src/test/destination\"); Set\u003cFile\u003e markdowns = sut.generateJBakeMarkdown(); assertThat(markdowns, is(empty())); File destination = new File(\"destination\"); destination.delete(); } Obviamente, esta en rojo, allá va la implementación:\npublic Set\u003cFile\u003e generateJBakeMarkdown() { return new HashSet\u003cFile\u003e(); } Y aquí, ya voy devolviendo un Set (porque todos los elementos serán distintos, cada archivo representa un post y cada post es único) y uso uno no ordenado, porque en realidad me dá igual el orden de iteración, ya que como decidí los archivos vendrán ordenados por su ruta, es decir, si existen, por definición estan ordenados.\nVale, y ahora, test de verdad:\n@Test public void processXML() { sut = new Wp2JBake(\"src/test/resources/wp-source.xml\", \"src/test/destination\"); Set\u003cFile\u003e markdowns = sut.generateJBakeMarkdown(); assertThat(markdowns, is(not(empty()))); for (File markdown: markdowns) { assertThat(markdown.exists(), is(true)); } File destination = new File(\"destination\"); destination.delete(); } Ahora tengo que modificar el método generateJBakeMarkdown para que genere los archivos Markdown. En un principio hay dos formas de hacer ésto:\nParseo el XML, genero una estructura de datos en memoria (una representación de los posts, vaya) y después la recorro y la paso a los archivos markdown. Desventaja, que para eso para qué demonios uso StAX y el streaming, si voy a comer memoria uso DOM y listo. Parseo el XML y cada vez que se detecte un item (un post) lo voy escribiendo dinámicamente. Creo que esta opción es más complicada, pero más ligera. Vamos a por 2, para ello leeré el XML y lo volcaré… pero un momento, una cosa es saber leer el XML y otra escribir el Markdown, es decir, que mi clase lectora (Wp2JBake) a su vez debe comunicarse (usar) otra para escribir (MdWriter). Pensando un poco más sobre esta clase MdWriter… debería recibir como parámetro en su constructor el destino de las escrituras y eso me lleva a pensar, que realmente es a ella a la que le corresponde comprobar si es un destino legal, es decir, que el constructor de Wp2JBake ahora quedaría así (también he aprovechado y origin lo he guardado en un atributo de la clase):\npublic Wp2JBake(String origin, String destination) { if (StringUtils.isEmpty(origin) || !existsOrigin(origin)) { throw new IllegalArgumentException(\"Origin is not a valid file\"); } else { this.origin = origin; } this.mdWriter = new MdWriter(destination); } Mientras que MdWriter sería así:\npublic class MdWriter { private File destinationFolder; public MdWriter(String destination) { if (StringUtils.isEmpty(destination) || !isWritable(destination)) { throw new IllegalArgumentException(\"Destination is not a valid folder\"); } else { destinationFolder = new File(destination); } } private boolean isWritable(String destination) { File destinationFolder = new File(destination); if (destinationFolder.exists()) { return destinationFolder.canWrite(); } else { return isWritableDestinationParent(destinationFolder); } } private boolean isWritableDestinationParent(File destinationFolder) { File destinationParent = getDestinationParent(destinationFolder); return destinationParent.canWrite(); } private File getDestinationParent(File destinationFolder) { String parentPath = destinationFolder.getParent(); if (parentPath == null) { parentPath = \"\"; } return new File(parentPath); } } Por cierto que la teoría TDDista dice que esto no debería hacerse, que primero hay que pasar el test y después ponerse a refactorizar y tal… Hombre, yo eso no lo comparto tanto, creo que esta bien ir pensando un poco las cosas. Además, como ya tengo hechos los tests, los puedo volver a ejecutar para ver que no me he cargado nada. Que hablando de las pruebas, ahora tengo que crear las pruebas propias de esta nueva clase y llevarme todas las encargadas de testear la corrección del directorio destino a esa clase. Al separarlo además ya no tengo que diferenciar entre los tipos de excepción (era muy cantoso que estaba pasando del Single Responsability) y el código queda mucho más limpio:\npublic class Wp2JBakeTests { private Wp2JBake sut; @Test(expected = IllegalArgumentException.class) public void buildWithoutParameters() { sut = new Wp2JBake(null, null); } @Test(expected = IllegalArgumentException.class) public void buildWithoutOrigin() { sut = new Wp2JBake(null, \"foo\"); } @Test(expected = IllegalArgumentException.class) public void buildWithEmptyOrigin() { sut = new Wp2JBake(\"\", \"\"); } @Test(expected = IllegalArgumentException.class) public void buildWithInvalidOrigin() { sut = new Wp2JBake(\"foo\", \"\"); } @Test public void buildWithValidParameters() { sut = new Wp2JBake(\"src/test/resources/wp-source.xml\", \"src/test/destination\"); } @Test public void processEmptyXML() { sut = new Wp2JBake(\"src/test/resources/empty.xml\", \"src/test/destination\"); Set\u003cFile\u003e markdowns = sut.generateJBakeMarkdown(); assertThat(markdowns, is(empty())); } @Test public void processXML() { sut = new Wp2JBake(\"src/test/resources/wp-source.xml\", \"src/test/destination\"); Set\u003cFile\u003e markdowns = sut.generateJBakeMarkdown(); assertThat(markdowns, is(not(empty()))); for (File markdown: markdowns) { assertThat(markdown.exists(), is(true)); } File destination = new File(\"destination\"); destination.delete(); } } public class MdWriterTest { private MdWriter sut; @Test(expected = IllegalArgumentException.class) public void writerWithoutDestination() { sut = new MdWriter(null); } @Test(expected = IllegalArgumentException.class) public void writerWithEmptyDestination() { sut = new MdWriter(\"\"); } @Test(expected = IllegalArgumentException.class) public void writerWithNonWritableDestination() { File destination = new File(\"destination\"); destination.mkdir(); destination.deleteOnExit(); destination.setReadOnly(); sut = new MdWriter(destination.getAbsolutePath()); } @Test(expected = IllegalArgumentException.class) public void writerWithNonWritableDestinationParent() { File destinationParent = new File(\"destinationParent\"); destinationParent.mkdir(); destinationParent.deleteOnExit(); destinationParent.setReadOnly(); sut = new MdWriter(destinationParent.getAbsolutePath() + File.separator + \"destination\"); } } Bueno, pues ahora tengo que leer el XML e ir cargando los Strings que el escritor se encargará de volcar a disco… muy bien. Lo primer es crear la factoría de eventos. Por cierto, menuda bazofia el tutorial oficial de Oracle, menos mal que Lars Vogel tiene un grandísimo tutorial (danke schön Lars!):\npublic Set\u003cFile\u003e generateJBakeMarkdown() { XMLEventReader eventReader = getEventReader(); return new HashSet\u003cFile\u003e(); } private XMLEventReader getEventReader() { XMLInputFactory inputFactory = XMLInputFactory.newInstance(); InputStream in = null; XMLEventReader eventReader = null; try { in = new FileInputStream(origin); eventReader = inputFactory.createXMLEventReader(in); } catch (FileNotFoundException e) { throw new IllegalStateException(\"Could not find origin file: \" + e.getMessage()); } catch (XMLStreamException e) { throw new IllegalStateException(\"Could not read origin file: \" + e.getMessage()); } return eventReader; } He optado por lanzar un IllegalStateException si ocurre alguna de las excepciones, ya que eso no debería ocurrir y a lo que lleva es exactamente a eso, un estado ilegal del programa :) Hmmm… por otra parte, tengo la prueba con el XML vacío, pero ahora que lo pienso ¡¡¡no tengo ninguna con un XML inválido!!! Me creo un XML invalid.xml que contiene solo la cabecera con un número de versión que no existe:\n\u003c?xml version=\"-1.0\" encoding=\"utf-8\"?\u003e Y su test:\n@Test(expected = IllegalStateException.class) public void processInvalidXML() { sut = new Wp2JBake(\"src/test/resources/invalid.xml\", \"src/test/destination\"); Set\u003cFile\u003e markdowns = sut.generateJBakeMarkdown(); } Me esta empezando a parecer que la lectura también debería ir en otra clase y Wp2JBake tan solo orquestrar la lectura con la escritura… pero bueno, ya iremos viendo de momento sigo, así. Toca tratar los eventos. El tutorial hace un típico bucle while con el eventReader que implementa Iterator, pero claro, el tutorial es antiguo, al fin y al cabo y pensándolo bien… yo lo que quiero hacer es un filter y un collect, es decir, que puedo usar la API de Streams de Java 8. La única historia es convertir el XMLEventReader a un Stream, pero eso es relativamente fácil:\npublic Set\u003cFile\u003e generateJBakeMarkdown() { XMLEventReader eventReader = getEventReader(); Iterable\u003cXMLEvent\u003e eventsIterable = () -\u003e eventReader; Stream\u003cXMLEvent\u003e xmlEvents = StreamSupport.stream(eventsIterable.spliterator(), false); return new HashSet\u003cFile\u003e(); } Bueno, pues después de echar hora y pico probando con filter, map, flatmap etc, hay un problema, y es que StAX entiende todo el documento secuencialmente, con lo cual no puedo hacer un filter y quedarme solo con los elemntos de tipo item y después acceder a los elementos que contienen estos, porque un elemento esta suelto, así que nada, toca iteradores y bucles for de toda la vida. Para que sea más entendible (y orientado a objetos), me voy a crear una clase Post para ir guardando los resultados y después volcarlos al archivo pertinente. Esta clase la monto con una API fluida para que la construcción me sea más sencilla y los correspondientes getters:\npublic class Post { private String title; private LocalDate publishingDate; private Set\u003cString\u003e tags = new TreeSet\u003c\u003e(); private String content; public Post () { } public Post withTitle(String title) { this.title = title; return this; } public Post withPublishingDate(LocalDate publishingDate) { this.publishingDate = publishingDate; return this; } public Post withTag(String tag) { this.tags.add(tag); return this; } public Post withContent(String content) { this.content = content; return this; } public String getTitle() { return title; } public LocalDate getPublishingDate() { return publishingDate; } public Set\u003cString\u003e getTags() { return tags; } public String getContent() { return content; } } En fín, ya han pasado como tres horas y el test sigue sin funcionar… me deprimo… Sigo con el for, la estrategia es muy sencilla, si detecto un elemento item, creo un nuevo Post y conforme vaya detectando los elementos title, pubDate, category y content voy invocando a los métodos with* del Post. En el momento que detecte el cierre del item, escribo a disco:\npublic Set\u003cFile\u003e generateJBakeMarkdown() { XMLEventReader eventReader = getEventReader(); Iterable\u003cXMLEvent\u003e eventsIterable = () -\u003e eventReader; Stream\u003cXMLEvent\u003e xmlEvents = StreamSupport.stream(eventsIterable.spliterator(), false); return new HashSet\u003cFile\u003e(); } Desafortunadamente, el tema es más complejo de lo que parecía. Dado que StAX solo lee en un sentido (palante), de poco me sirve la API de streams de Java 8, ya que tengo que ir tomando decisiones en función del elemento que llegue, por ejemplo, un elemento title se debe ignorar salvo que previamente se haya recibido un item. No digo que no sea posible hacerlo con streams, solo que después de muchos relíos es más sencillo hacerlo con dos while:\nEl primer while que itera sobre todos los elementos proporcionados por StAX. El segundo while empieza cuando se detecta un item y termina cuando se cierra el item, leyendo por tanto un post completo. Con esto en mente es bastante fácil:\npublic Set\u003cFile\u003e generateJBakeMarkdown() { HashSet\u003cFile\u003e exportResult = new HashSet\u003c\u003e(); XMLEventReader eventReader = getEventReader(); try { exportPosts(exportResult, eventReader); } catch (XMLStreamException e) { throw new IllegalStateException(\"Error reading XML \" + origin + \": \" + e.getMessage()); } return exportResult; } private void exportPosts(HashSet\u003cFile\u003e exportResult, XMLEventReader eventReader) throws XMLStreamException { Post post = null; while (eventReader.hasNext()) { XMLEvent event = eventReader.nextEvent(); if (isPostStart(event)) { post = exportPost(exportResult, eventReader, post); } } } private Post exportPost(HashSet\u003cFile\u003e exportResult, XMLEventReader eventReader, Post post) throws XMLStreamException { if (post != null) { exportResult.add(mdWriter.write(post)); } post = readPost(eventReader); return post; } private Post readPost(XMLEventReader eventReader) throws XMLStreamException { Post exportedPost = new Post(); boolean postRead = false; while (!postRead \u0026\u0026 eventReader.hasNext()) { XMLEvent event = eventReader.nextEvent(); if (event.isStartElement()) { exportedPost = loadPostFromEvent(event, eventReader, exportedPost); } else if (isPostEnd(event)) { postRead = true; } } return exportedPost; } private boolean isPostEnd(XMLEvent event) { return event.isEndElement() \u0026\u0026 \"item\".equals(event.asEndElement().getName().getPrefix() + event.asEndElement().getName().getLocalPart()); } private boolean isPostStart(XMLEvent event) { return event.isStartElement() \u0026\u0026 \"item\".equals(getEventFullName(event)); } private Post loadPostFromEvent(XMLEvent event, XMLEventReader eventReader, Post post) { String name = getEventFullName(event); try { switch (name) { case \"title\": post = loadTitle(eventReader, post); break; case \"pubDate\": post = loadPublishingDate(eventReader, post); break; case \"category\": if (isTag(event)) { post = loadCategory(eventReader, event, post); } break; case \"contentencoded\": post = loadContent(eventReader, post); break; default: break; } } catch (XMLStreamException e) { throw new IllegalStateException(\"Error parsing \" + name + \": \" + e.getMessage()); } return post; } private Post loadContent(XMLEventReader eventReader, Post post) throws XMLStreamException { return post.withContent(eventReader.nextEvent().asCharacters().getData()); } private Post loadCategory(XMLEventReader eventReader, XMLEvent event, Post post) throws XMLStreamException { return post.withTag(eventReader.nextEvent().asCharacters().getData()); } private Post loadPublishingDate(XMLEventReader eventReader, Post post) throws XMLStreamException { return post.withPublishingDate(parsePubDate(eventReader)); } private Post loadTitle(XMLEventReader eventReader, Post post) throws XMLStreamException { return post.withTitle(eventReader.nextEvent().asCharacters().getData()); } private String getEventFullName(XMLEvent event) { return event.asStartElement().getName().getPrefix() + event.asStartElement().getName().getLocalPart(); } private boolean isTag(XMLEvent event) { return \"post_tag\".equals(event.asStartElement().getAttributeByName(new QName(\"domain\")).getValue()); } private Date parsePubDate(XMLEventReader eventReader) throws XMLStreamException { Date publishingDate = null; try { String pubDate = eventReader.nextEvent().asCharacters().getData(); pubDate = extractDate(pubDate); SimpleDateFormat format = new SimpleDateFormat(\"dd MMM yyyy\"); publishingDate = format.parse(pubDate); } catch (ParseException e) { throw new IllegalStateException(\"Could not parse pubDate: \" + e.getMessage()); } return publishingDate; } private String extractDate(String pubDate) { //Date is supplied as this: Wed, 30 Nov -0001 00:00:00 +0000, we need to extract just the date pubDate = pubDate.substring(pubDate.indexOf(\",\")+2); int hourIndex = pubDate.indexOf(\":\")-3; pubDate = pubDate.substring(0, hourIndex); return pubDate; } private XMLEventReader getEventReader() { XMLInputFactory inputFactory = XMLInputFactory.newInstance(); InputStream in = null; XMLEventReader eventReader = null; try { in = new FileInputStream(origin); eventReader = inputFactory.createXMLEventReader(in); } catch (FileNotFoundException e) { throw new IllegalStateException(\"Could not find origin file: \" + e.getMessage()); } catch (XMLStreamException e) { throw new IllegalStateException(\"Could not read origin file: \" + e.getMessage()); } return eventReader; } private boolean existsOrigin(String origin) { File originFile = new File(origin); String path = originFile.getAbsolutePath(); return originFile.exists(); } Lo del parseo de la fecha ha sido un espectáculo… no he sido capaz de sacarlo con el DateFormatter para convertirlo a un LocalDate. Bueno, pues ahora que lo tengo… ¿no tendría más sentido que todo eso fuera a una clase propia? Digamos WpReader. Pues sí, porque ahora mismo mi clase principal se esta responsabilizando de saber como se leen los posts y qué hacer con los posts leidos, así que es mucho más claro hacerlo con una colaboradora. Pero claro, si me llevo la lógica aparte, ¿cómo aviso de que se puede escribir un nuevo post sin romper el while que itera sobre todos los elementos del XML? Bueno, pues finamente diría que voy a usar un patrón observador, para notificar de cuando hay un nuevo post. Técnicamente lo que voy a hacer es implementar un callback y así Wp2JBake queda mucho más clara:\npublic class Wp2JBake { private WpReader wpReader; private MdWriter mdWriter; private HashSet\u003cFile\u003e exportResult; public Wp2JBake(String origin, String destination) { this.wpReader = new WpReader(origin); this.mdWriter = new MdWriter(destination); } public Set\u003cFile\u003e generateJBakeMarkdown() { exportResult = new HashSet\u003c\u003e(); wpReader.readPosts(this); return exportResult; } public void postRead(Post post) { exportResult.add(mdWriter.write(post)); } } Y por otro lado tenemos WpReader:\npublic class WpReader { public static final String ITEM = \"item\"; public static final String TITLE = \"title\"; public static final String PUB_DATE = \"pubDate\"; public static final String CATEGORY = \"category\"; public static final String CONTENT = \"contentencoded\"; public static final String POST_TAG = \"post_tag\"; public static final String DOMAIN = \"domain\"; private String origin; public WpReader(String origin) { if (StringUtils.isEmpty(origin) || !existsOrigin(origin)) { throw new IllegalArgumentException(\"Origin is not a valid file\"); } else { this.origin = origin; } } private boolean existsOrigin(String origin) { File originFile = new File(origin); return originFile.exists(); } public void readPosts(Wp2JBake wp2JBake) { XMLEventReader eventReader = getEventReader(); try { readXML(wp2JBake, eventReader); } catch (XMLStreamException e) { throw new IllegalStateException(\"Error reading XML \" + origin + \": \" + e.getMessage()); } } private void readXML(Wp2JBake wp2JBake, XMLEventReader eventReader) throws XMLStreamException { while (eventReader.hasNext()) { readElement(wp2JBake, eventReader); } } private void readElement(Wp2JBake wp2JBake, XMLEventReader eventReader) throws XMLStreamException { XMLEvent event = eventReader.nextEvent(); if (isPostStart(event)) { Post post = readPost(eventReader); wp2JBake.postRead(post); } } private Post readPost(XMLEventReader eventReader) throws XMLStreamException { Post exportedPost = new Post(); boolean postRead = false; while (!postRead \u0026\u0026 eventReader.hasNext()) { XMLEvent event = eventReader.nextEvent(); if (event.isStartElement()) { exportedPost = loadAttribute(event, eventReader, exportedPost); } else if (isPostEnd(event)) { postRead = true; } } return exportedPost; } private boolean isPostEnd(XMLEvent event) { return event.isEndElement() \u0026\u0026 ITEM.equals(event.asEndElement().getName().getPrefix() + event.asEndElement().getName().getLocalPart()); } private Post loadAttribute(XMLEvent event, XMLEventReader eventReader, Post post) { String name = getEventFullName(event); try { post = loadAttribute(event, eventReader, post, name); } catch (XMLStreamException e) { throw new IllegalStateException(\"Error parsing \" + name + \": \" + e.getMessage()); } return post; } private Post loadAttribute(XMLEvent event, XMLEventReader eventReader, Post post, String name) throws XMLStreamException { switch (name) { case TITLE: post = loadTitle(eventReader, post); break; case PUB_DATE: post = loadPublishingDate(eventReader, post); break; case CATEGORY: if (isTag(event)) { post = loadCategory(eventReader, post); } break; case CONTENT: post = loadContent(eventReader, post); break; default: break; } return post; } private Post loadContent(XMLEventReader eventReader, Post post) throws XMLStreamException { return post.withContent(eventReader.nextEvent().asCharacters().getData()); } private Post loadCategory(XMLEventReader eventReader, Post post) throws XMLStreamException { return post.withTag(eventReader.nextEvent().asCharacters().getData()); } private Post loadPublishingDate(XMLEventReader eventReader, Post post) throws XMLStreamException { return post.withPublishingDate(parsePubDate(eventReader)); } private Post loadTitle(XMLEventReader eventReader, Post post) throws XMLStreamException { return post.withTitle(eventReader.nextEvent().asCharacters().getData()); } private boolean isTag(XMLEvent event) { return POST_TAG.equals(event.asStartElement().getAttributeByName(new QName(DOMAIN)).getValue()); } private Date parsePubDate(XMLEventReader eventReader) throws XMLStreamException { Date publishingDate = null; try { String pubDate = eventReader.nextEvent().asCharacters().getData(); pubDate = extractDate(pubDate); SimpleDateFormat format = new SimpleDateFormat(\"dd MMM yyyy\"); publishingDate = format.parse(pubDate); } catch (ParseException e) { throw new IllegalStateException(\"Could not parse pubDate: \" + e.getMessage()); } return publishingDate; } private String extractDate(String pubDate) { //Date is supplied as this: Wed, 30 Nov -0001 00:00:00 +0000 (RFC822 presumably), we need to extract just the date pubDate = pubDate.substring(pubDate.indexOf(\",\")+2); int hourIndex = pubDate.indexOf(\":\")-3; pubDate = pubDate.substring(0, hourIndex); return pubDate; } private boolean isPostStart(XMLEvent event) { return event.isStartElement() \u0026\u0026 ITEM.equals(getEventFullName(event)); } private String getEventFullName(XMLEvent event) { return event.asStartElement().getName().getPrefix() + event.asStartElement().getName().getLocalPart(); } private XMLEventReader getEventReader() { XMLInputFactory inputFactory = XMLInputFactory.newInstance(); InputStream in = null; XMLEventReader eventReader = null; try { in = new FileInputStream(origin); eventReader = inputFactory.createXMLEventReader(in); } catch (FileNotFoundException e) { throw new IllegalStateException(\"Could not find origin file: \" + e.getMessage()); } catch (XMLStreamException e) { throw new IllegalStateException(\"Could not read origin file: \" + e.getMessage()); } return eventReader; } } Pues para terminar con esta sección que se ha alargado más de lo que esperaba, me queda modificar los tests:\n@RunWith(MockitoJUnitRunner.class) public class WpReaderTest { private WpReader sut; @Mock private Wp2JBake observer; @Test(expected = IllegalArgumentException.class) public void readerWithoutOrigin() { sut = new WpReader(null); } @Test(expected = IllegalArgumentException.class) public void readerWithEmptyOrigin() { sut = new WpReader(\"\"); } @Test(expected = IllegalArgumentException.class) public void buildWithInvalidOrigin() { sut = new WpReader(\"foo\"); } @Test(expected = IllegalStateException.class) public void readEmptyXML() { sut = new WpReader(\"src/test/resources/empty.xml\"); sut.readPosts(observer); } @Test(expected = IllegalStateException.class) public void readInvalidXML() { sut = new WpReader(\"src/test/resources/invalid.xml\"); sut.readPosts(observer); } @Test public void readValidXML() { sut = new WpReader(\"src/test/resources/wp-source.xml\"); ArgumentCaptor\u003cPost\u003e postCapturer = ArgumentCaptor.forClass(Post.class); sut.readPosts(observer); verify(observer, times(7)).postRead(postCapturer.capture()); } } Con esto ya ha quedado perfecto, si no tanto el software, si los tests. Cada clase tiene una responsabilidad bien definida y así se refleja en los tests. Eso sí, en esta última clase he tenido que meter Mockito para simular el Wp2JBake que me hace falta para el callback. Lo bueno de esto es que con Mockito puedo verificar las llamadas a los métodos y por primera vez tengo todos los tests en verde. Eso sí, los tests de Wp2JBake se han quedado en realidad como pruebas de integración, así que no me preocupa que el test original siga en rojo porque realmente hasta que no este implementada la escritura no debería pasar a verde :).\n","wordCount":"3460","inLanguage":"en","datePublished":"2016-03-20T00:00:00Z","dateModified":"2016-03-20T00:00:00Z","author":{"@type":"Person","name":"Agustín Ventura Carrasco"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.aguasnegras.es/posts/2016/03/20-wp2jbake-parseo/"},"publisher":{"@type":"Organization","name":"AguasNegras","logo":{"@type":"ImageObject","url":"https://www.aguasnegras.es/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.aguasnegras.es/ accesskey=h title="AguasNegras (Alt + H)">AguasNegras</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.aguasnegras.es/archives/ title=archivos><span>archivos</span></a></li><li><a href=https://www.aguasnegras.es/tags/ title=tags><span>tags</span></a></li><li><a href=https://www.aguasnegras.es/about/ title="acerca de"><span>acerca de</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.aguasnegras.es/>Home</a>&nbsp;»&nbsp;<a href=https://www.aguasnegras.es/posts/>Posts</a></div><h1 class=post-title>Wordpress to JBake - Parseo</h1><div class=post-meta><span title='2016-03-20 00:00:00 +0000 UTC'>20 March 2016</span>&nbsp;·&nbsp;17 min&nbsp;·&nbsp;3460 words&nbsp;·&nbsp;Agustín Ventura Carrasco&nbsp;|&nbsp;<a href=https://github.com/agustinventura.github.io/content/posts/2016/03/20-wp2jbake-parseo.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>Pues ahora que ya tengo el constructor y construyo un objeto siempre que, al menos es coherente, toca parsear el xml para extraer los datos.
En Java, esencialmente hay tres formas de parsear xml, todas dentro de lo que se denomina Java XML Processing API, <a href=https://docs.oracle.com/javase/tutorial/jaxp/index.html>JAXP</a>:</p><ol><li><a href=https://docs.oracle.com/javase/tutorial/jaxp/sax/index.html>SAX</a>: La API originaria, orientada a eventos. Muy rápida, muy eficiente y muy farragosa. Técnicamente es una API de streaming mediante push, es decir, nosotros arrancamos el procesamiento del documento y la API empieza a funcionar mandándonos eventos conforme va encontrando elementos.</li><li><a href=https://docs.oracle.com/javase/tutorial/jaxp/dom/index.html>DOM</a>: La API orientada a objetos, representa el XML como un árbol en memoria. Muy fácil de acceder, muy tragón de recursos. Técnicamente, se representa el árbol del DOM en memoria y listo, se puede acceder libremente, por ejemplo usando XPath.</li><li><a href=https://docs.oracle.com/javase/tutorial/jaxp/stax/index.html>StAX</a>: A partir del JDK 1.5 se encuentra disponible esta API que es un modelo mixto, se basa en un modelo de streaming (parecido a SAX) pero más sencillo de utilizar y además permite escribir. Técnicamente se define como una API de streming mediante pull, es decir, que somos nosotros los que vamos indicanto los elementos que queremos acceder. Eso sí, al ser de streaming solo permite avanzar en el documento, es decir, no podemos ignorar el elemento 1, tratar el 2 y en función de este retroceder a tratar el 1.</li></ol><p>En mi caso en particular, y dado que el modelo de &ldquo;ir hacia delante&rdquo; se adapta perfectamente al caso de uso (ya que simplemente estoy emparejando), pero tampoco necesito tantísima eficiencia ni tengo ganas de fastidiarme la vida, voy a utilizar StAX.</p><p>Pero lo primero, ahora que tengo que trabajar &ldquo;en serio&rdquo; es utilizar datos de verdad para las pruebas. Para eso hay dos opciones:</p><ol><li>Guardo un XML de pruebas en forma de un String en un archivo .java y lo leo de ahí.</li><li>Guardo un archivo XML como tal.</li></ol><p>Pues como que la primera opción es una tontería, he optado por la segunda. He sacado la exportación de datos que proporciona Wordpress y he dejado unos cuantos posts que sean más o menos representativos y listo. Lo guardo en <em>src/resources/wp-source.xml</em>. Antes de seguir, ya no tiene sentido que los tests sigan usando el <em>pom.xml</em> para las pruebas, así que lo cambio y lo lanzo. Todo en verde, como cabía esperar.</p><p>Ahora bien, ya tengo mi objeto de la clase Wp2JBake creado con el origen y el destino debidamente especificado, ¿como arranco el procesamiento? Hay que tener en cuenta que realmente el método de proceso no tiene por qué devolver nada, ya que el resultado efectivo de la salida es una estructura de archivos con el resultado de la conversión.
Sin embargo, creo que es &ldquo;gratis&rdquo; devolver los elementos que se han generado y así se posibilita poder comprobar el resultado de la generación.</p><p>Así que primero el test:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>processEmptyXML</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Wp2JBake</span><span class=o>(</span><span class=s>&#34;src/test/resources/empty.xml&#34;</span><span class=o>,</span> <span class=s>&#34;src/test/destination&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=n>markdowns</span> <span class=o>=</span> <span class=n>sut</span><span class=o>.</span><span class=na>generateJBakeMarkdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>assertThat</span><span class=o>(</span><span class=n>markdowns</span><span class=o>,</span> <span class=n>is</span><span class=o>(</span><span class=n>empty</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>    <span class=n>File</span> <span class=n>destination</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=s>&#34;destination&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>destination</span><span class=o>.</span><span class=na>delete</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Obviamente, esta en rojo, allá va la implementación:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=nf>generateJBakeMarkdown</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Y aquí, ya voy devolviendo un Set (porque todos los elementos serán distintos, cada archivo representa un post y cada post es único) y uso uno no ordenado, porque en realidad me dá igual el orden de iteración, ya que <a href=../02/04-wp2jbake.html>como decidí</a> los archivos vendrán ordenados por su ruta, es decir, si existen, por definición estan ordenados.</p><p>Vale, y ahora, test de verdad:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>processXML</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Wp2JBake</span><span class=o>(</span><span class=s>&#34;src/test/resources/wp-source.xml&#34;</span><span class=o>,</span> <span class=s>&#34;src/test/destination&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=n>markdowns</span> <span class=o>=</span> <span class=n>sut</span><span class=o>.</span><span class=na>generateJBakeMarkdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>assertThat</span><span class=o>(</span><span class=n>markdowns</span><span class=o>,</span> <span class=n>is</span><span class=o>(</span><span class=n>not</span><span class=o>(</span><span class=n>empty</span><span class=o>())));</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=o>(</span><span class=n>File</span> <span class=n>markdown</span><span class=o>:</span> <span class=n>markdowns</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>assertThat</span><span class=o>(</span><span class=n>markdown</span><span class=o>.</span><span class=na>exists</span><span class=o>(),</span> <span class=n>is</span><span class=o>(</span><span class=kc>true</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>File</span> <span class=n>destination</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=s>&#34;destination&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>destination</span><span class=o>.</span><span class=na>delete</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Ahora tengo que modificar el método <em>generateJBakeMarkdown</em> para que genere los archivos Markdown. En un principio hay dos formas de hacer ésto:</p><ol><li>Parseo el XML, genero una estructura de datos en memoria (una representación de los posts, vaya) y después la recorro y la paso a los archivos markdown. Desventaja, que para eso para qué demonios uso StAX y el streaming, si voy a comer memoria uso DOM y listo.</li><li>Parseo el XML y cada vez que se detecte un item (un post) lo voy escribiendo dinámicamente. Creo que esta opción es más complicada, pero más ligera.</li></ol><p>Vamos a por 2, para ello leeré el XML y lo volcaré&mldr; pero un momento, una cosa es saber leer el XML y otra escribir el Markdown, es decir, que mi clase lectora (<em>Wp2JBake</em>) a su vez debe comunicarse (usar) otra para escribir (<em>MdWriter</em>).
Pensando un poco más sobre esta clase <em>MdWriter</em>&mldr; debería recibir como parámetro en su constructor el destino de las escrituras y eso me lleva a pensar, que realmente es a ella a la que le corresponde comprobar si es un destino legal, es decir, que el constructor de <em>Wp2JBake</em> ahora quedaría así (también he aprovechado y <em>origin</em> lo he guardado en un atributo de la clase):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=nf>Wp2JBake</span><span class=o>(</span><span class=n>String</span> <span class=n>origin</span><span class=o>,</span> <span class=n>String</span> <span class=n>destination</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>origin</span><span class=o>)</span> <span class=o>||</span> <span class=o>!</span><span class=n>existsOrigin</span><span class=o>(</span><span class=n>origin</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Origin is not a valid file&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>origin</span> <span class=o>=</span> <span class=n>origin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>mdWriter</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MdWriter</span><span class=o>(</span><span class=n>destination</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Mientras que <em>MdWriter</em> sería así:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MdWriter</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>File</span> <span class=n>destinationFolder</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>MdWriter</span><span class=o>(</span><span class=n>String</span> <span class=n>destination</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>destination</span><span class=o>)</span> <span class=o>||</span> <span class=o>!</span><span class=n>isWritable</span><span class=o>(</span><span class=n>destination</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Destination is not a valid folder&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>destinationFolder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>destination</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>isWritable</span><span class=o>(</span><span class=n>String</span> <span class=n>destination</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>File</span> <span class=n>destinationFolder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>destination</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>destinationFolder</span><span class=o>.</span><span class=na>exists</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>destinationFolder</span><span class=o>.</span><span class=na>canWrite</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>isWritableDestinationParent</span><span class=o>(</span><span class=n>destinationFolder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>isWritableDestinationParent</span><span class=o>(</span><span class=n>File</span> <span class=n>destinationFolder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>File</span> <span class=n>destinationParent</span> <span class=o>=</span> <span class=n>getDestinationParent</span><span class=o>(</span><span class=n>destinationFolder</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>destinationParent</span><span class=o>.</span><span class=na>canWrite</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>File</span> <span class=nf>getDestinationParent</span><span class=o>(</span><span class=n>File</span> <span class=n>destinationFolder</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>parentPath</span> <span class=o>=</span> <span class=n>destinationFolder</span><span class=o>.</span><span class=na>getParent</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>parentPath</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>parentPath</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>parentPath</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Por cierto que la teoría TDDista dice que esto no debería hacerse, que primero hay que pasar el test y después ponerse a refactorizar y tal&mldr; Hombre, yo eso no lo comparto tanto, creo que esta bien ir pensando un poco las cosas. Además, como ya tengo hechos los tests, los puedo volver a ejecutar para ver que no me he cargado nada.
Que hablando de las pruebas, ahora tengo que crear las pruebas propias de esta nueva clase y llevarme todas las encargadas de testear la corrección del directorio destino a esa clase. Al separarlo además ya no tengo que diferenciar entre los tipos de excepción (era muy cantoso que estaba pasando del Single Responsability) y el código queda mucho más limpio:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Wp2JBakeTests</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Wp2JBake</span> <span class=n>sut</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span><span class=o>(</span><span class=n>expected</span> <span class=o>=</span> <span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>buildWithoutParameters</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Wp2JBake</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span><span class=o>(</span><span class=n>expected</span> <span class=o>=</span> <span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>buildWithoutOrigin</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Wp2JBake</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=s>&#34;foo&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span><span class=o>(</span><span class=n>expected</span> <span class=o>=</span> <span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>buildWithEmptyOrigin</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Wp2JBake</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=o>,</span> <span class=s>&#34;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span><span class=o>(</span><span class=n>expected</span> <span class=o>=</span> <span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>buildWithInvalidOrigin</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Wp2JBake</span><span class=o>(</span><span class=s>&#34;foo&#34;</span><span class=o>,</span> <span class=s>&#34;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>buildWithValidParameters</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Wp2JBake</span><span class=o>(</span><span class=s>&#34;src/test/resources/wp-source.xml&#34;</span><span class=o>,</span> <span class=s>&#34;src/test/destination&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>processEmptyXML</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Wp2JBake</span><span class=o>(</span><span class=s>&#34;src/test/resources/empty.xml&#34;</span><span class=o>,</span> <span class=s>&#34;src/test/destination&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Set</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=n>markdowns</span> <span class=o>=</span> <span class=n>sut</span><span class=o>.</span><span class=na>generateJBakeMarkdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>assertThat</span><span class=o>(</span><span class=n>markdowns</span><span class=o>,</span> <span class=n>is</span><span class=o>(</span><span class=n>empty</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>processXML</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Wp2JBake</span><span class=o>(</span><span class=s>&#34;src/test/resources/wp-source.xml&#34;</span><span class=o>,</span> <span class=s>&#34;src/test/destination&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Set</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=n>markdowns</span> <span class=o>=</span> <span class=n>sut</span><span class=o>.</span><span class=na>generateJBakeMarkdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>assertThat</span><span class=o>(</span><span class=n>markdowns</span><span class=o>,</span> <span class=n>is</span><span class=o>(</span><span class=n>not</span><span class=o>(</span><span class=n>empty</span><span class=o>())));</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=o>(</span><span class=n>File</span> <span class=n>markdown</span><span class=o>:</span> <span class=n>markdowns</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>assertThat</span><span class=o>(</span><span class=n>markdown</span><span class=o>.</span><span class=na>exists</span><span class=o>(),</span> <span class=n>is</span><span class=o>(</span><span class=kc>true</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>File</span> <span class=n>destination</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=s>&#34;destination&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>destination</span><span class=o>.</span><span class=na>delete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MdWriterTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>MdWriter</span> <span class=n>sut</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span><span class=o>(</span><span class=n>expected</span> <span class=o>=</span> <span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>writerWithoutDestination</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MdWriter</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span><span class=o>(</span><span class=n>expected</span> <span class=o>=</span> <span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>writerWithEmptyDestination</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MdWriter</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span><span class=o>(</span><span class=n>expected</span> <span class=o>=</span> <span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>writerWithNonWritableDestination</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>File</span> <span class=n>destination</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=s>&#34;destination&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>destination</span><span class=o>.</span><span class=na>mkdir</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>destination</span><span class=o>.</span><span class=na>deleteOnExit</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>destination</span><span class=o>.</span><span class=na>setReadOnly</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MdWriter</span><span class=o>(</span><span class=n>destination</span><span class=o>.</span><span class=na>getAbsolutePath</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span><span class=o>(</span><span class=n>expected</span> <span class=o>=</span> <span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>writerWithNonWritableDestinationParent</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>File</span> <span class=n>destinationParent</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=s>&#34;destinationParent&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>destinationParent</span><span class=o>.</span><span class=na>mkdir</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>destinationParent</span><span class=o>.</span><span class=na>deleteOnExit</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>destinationParent</span><span class=o>.</span><span class=na>setReadOnly</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MdWriter</span><span class=o>(</span><span class=n>destinationParent</span><span class=o>.</span><span class=na>getAbsolutePath</span><span class=o>()</span> <span class=o>+</span> <span class=n>File</span><span class=o>.</span><span class=na>separator</span> <span class=o>+</span> <span class=s>&#34;destination&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Bueno, pues ahora tengo que leer el XML e ir cargando los Strings que el escritor se encargará de volcar a disco&mldr; muy bien. Lo primer es crear la factoría de eventos. Por cierto, menuda bazofia el tutorial oficial de Oracle, menos mal que <a href=http://www.vogella.com/tutorials/JavaXML/article.html>Lars Vogel</a> tiene un grandísimo tutorial (danke schön Lars!):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=nf>generateJBakeMarkdown</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>XMLEventReader</span> <span class=n>eventReader</span> <span class=o>=</span> <span class=n>getEventReader</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>XMLEventReader</span> <span class=nf>getEventReader</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>XMLInputFactory</span> <span class=n>inputFactory</span> <span class=o>=</span> <span class=n>XMLInputFactory</span><span class=o>.</span><span class=na>newInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>InputStream</span> <span class=n>in</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>XMLEventReader</span> <span class=n>eventReader</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>in</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileInputStream</span><span class=o>(</span><span class=n>origin</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>eventReader</span> <span class=o>=</span> <span class=n>inputFactory</span><span class=o>.</span><span class=na>createXMLEventReader</span><span class=o>(</span><span class=n>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>FileNotFoundException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Could not find origin file: &#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>XMLStreamException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Could not read origin file: &#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>eventReader</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></div><p>He optado por lanzar un IllegalStateException si ocurre alguna de las excepciones, ya que eso no debería ocurrir y a lo que lleva es exactamente a eso, un estado ilegal del programa :)
Hmmm&mldr; por otra parte, tengo la prueba con el XML vacío, pero ahora que lo pienso ¡¡¡no tengo ninguna con un XML inválido!!! Me creo un XML <em>invalid.xml</em> que contiene solo la cabecera con un número de versión que no existe:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;-1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span></code></pre></div><p>Y su test:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=o>(</span><span class=n>expected</span> <span class=o>=</span> <span class=n>IllegalStateException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>processInvalidXML</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Wp2JBake</span><span class=o>(</span><span class=s>&#34;src/test/resources/invalid.xml&#34;</span><span class=o>,</span> <span class=s>&#34;src/test/destination&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=n>markdowns</span> <span class=o>=</span> <span class=n>sut</span><span class=o>.</span><span class=na>generateJBakeMarkdown</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Me esta empezando a parecer que la lectura también debería ir en otra clase y <em>Wp2JBake</em> tan solo orquestrar la lectura con la escritura&mldr; pero bueno, ya iremos viendo de momento sigo, así. Toca tratar los eventos. El tutorial hace un típico bucle while con el eventReader que implementa <em>Iterator</em>, pero claro, el tutorial es antiguo, al fin y al cabo y pensándolo bien&mldr; yo lo que quiero hacer es un filter y un collect, es decir, que puedo usar la API de Streams de Java 8. La única historia es convertir el <em>XMLEventReader</em> a un <em>Stream</em>, pero eso es relativamente fácil:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=nf>generateJBakeMarkdown</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>XMLEventReader</span> <span class=n>eventReader</span> <span class=o>=</span> <span class=n>getEventReader</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Iterable</span><span class=o>&lt;</span><span class=n>XMLEvent</span><span class=o>&gt;</span> <span class=n>eventsIterable</span> <span class=o>=</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=n>eventReader</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Stream</span><span class=o>&lt;</span><span class=n>XMLEvent</span><span class=o>&gt;</span> <span class=n>xmlEvents</span> <span class=o>=</span> <span class=n>StreamSupport</span><span class=o>.</span><span class=na>stream</span><span class=o>(</span><span class=n>eventsIterable</span><span class=o>.</span><span class=na>spliterator</span><span class=o>(),</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Bueno, pues después de echar hora y pico probando con filter, map, flatmap etc, hay un problema, y es que StAX entiende todo el documento secuencialmente, con lo cual no puedo hacer un filter y quedarme solo con los elemntos de tipo <em>item</em> y después acceder a los elementos que contienen estos, porque un elemento esta suelto, así que nada, toca iteradores y bucles for de toda la vida. Para que sea más entendible (y orientado a objetos), me voy a crear una clase <em>Post</em> para ir guardando los resultados y después volcarlos al archivo pertinente.
Esta clase la monto con una API fluida para que la construcción me sea más sencilla y los correspondientes getters:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Post</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>title</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>LocalDate</span> <span class=n>publishingDate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>tags</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TreeSet</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>content</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Post</span> <span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Post</span> <span class=nf>withTitle</span><span class=o>(</span><span class=n>String</span> <span class=n>title</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>title</span> <span class=o>=</span> <span class=n>title</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Post</span> <span class=nf>withPublishingDate</span><span class=o>(</span><span class=n>LocalDate</span> <span class=n>publishingDate</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>publishingDate</span> <span class=o>=</span> <span class=n>publishingDate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Post</span> <span class=nf>withTag</span><span class=o>(</span><span class=n>String</span> <span class=n>tag</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>tags</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>tag</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Post</span> <span class=nf>withContent</span><span class=o>(</span><span class=n>String</span> <span class=n>content</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>content</span> <span class=o>=</span> <span class=n>content</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>String</span> <span class=nf>getTitle</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>title</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>LocalDate</span> <span class=nf>getPublishingDate</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>publishingDate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=nf>getTags</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>tags</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>String</span> <span class=nf>getContent</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>content</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>En fín, ya han pasado como tres horas y el test sigue sin funcionar&mldr; me deprimo&mldr;
Sigo con el for, la estrategia es muy sencilla, si detecto un elemento <em>item</em>, creo un nuevo <em>Post</em> y conforme vaya detectando los elementos <em>title</em>, <em>pubDate</em>, <em>category</em> y <em>content</em> voy invocando a los métodos <em>with*</em> del <em>Post</em>. En el momento que detecte el cierre del <em>item</em>, escribo a disco:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=nf>generateJBakeMarkdown</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>XMLEventReader</span> <span class=n>eventReader</span> <span class=o>=</span> <span class=n>getEventReader</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Iterable</span><span class=o>&lt;</span><span class=n>XMLEvent</span><span class=o>&gt;</span> <span class=n>eventsIterable</span> <span class=o>=</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=n>eventReader</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Stream</span><span class=o>&lt;</span><span class=n>XMLEvent</span><span class=o>&gt;</span> <span class=n>xmlEvents</span> <span class=o>=</span> <span class=n>StreamSupport</span><span class=o>.</span><span class=na>stream</span><span class=o>(</span><span class=n>eventsIterable</span><span class=o>.</span><span class=na>spliterator</span><span class=o>(),</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Desafortunadamente, el tema es más complejo de lo que parecía. Dado que StAX solo lee en un sentido (palante), de poco me sirve la API de streams de Java 8, ya que tengo que ir tomando decisiones en función del elemento que llegue, por ejemplo, un elemento <em>title</em> se debe ignorar salvo que previamente se haya recibido un <em>item</em>.
No digo que no sea posible hacerlo con streams, solo que después de muchos relíos es más sencillo hacerlo con dos while:</p><ol><li>El primer while que itera sobre todos los elementos proporcionados por StAX.</li><li>El segundo while empieza cuando se detecta un <em>item</em> y termina cuando se cierra el <em>item</em>, leyendo por tanto un post completo.</li></ol><p>Con esto en mente es bastante fácil:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=nf>generateJBakeMarkdown</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>HashSet</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=n>exportResult</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=n>XMLEventReader</span> <span class=n>eventReader</span> <span class=o>=</span> <span class=n>getEventReader</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>exportPosts</span><span class=o>(</span><span class=n>exportResult</span><span class=o>,</span> <span class=n>eventReader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>XMLStreamException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Error reading XML &#34;</span> <span class=o>+</span> <span class=n>origin</span> <span class=o>+</span> <span class=s>&#34;: &#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>exportResult</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>exportPosts</span><span class=o>(</span><span class=n>HashSet</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=n>exportResult</span><span class=o>,</span> <span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Post</span> <span class=n>post</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=n>eventReader</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>XMLEvent</span> <span class=n>event</span> <span class=o>=</span> <span class=n>eventReader</span><span class=o>.</span><span class=na>nextEvent</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>isPostStart</span><span class=o>(</span><span class=n>event</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>post</span> <span class=o>=</span> <span class=n>exportPost</span><span class=o>(</span><span class=n>exportResult</span><span class=o>,</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>post</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Post</span> <span class=nf>exportPost</span><span class=o>(</span><span class=n>HashSet</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=n>exportResult</span><span class=o>,</span> <span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>Post</span> <span class=n>post</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>post</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>exportResult</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>mdWriter</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>post</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>post</span> <span class=o>=</span> <span class=n>readPost</span><span class=o>(</span><span class=n>eventReader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>post</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Post</span> <span class=nf>readPost</span><span class=o>(</span><span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Post</span> <span class=n>exportedPost</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Post</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>postRead</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=o>(!</span><span class=n>postRead</span> <span class=o>&amp;&amp;</span> <span class=n>eventReader</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>XMLEvent</span> <span class=n>event</span> <span class=o>=</span> <span class=n>eventReader</span><span class=o>.</span><span class=na>nextEvent</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>isStartElement</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>exportedPost</span> <span class=o>=</span> <span class=n>loadPostFromEvent</span><span class=o>(</span><span class=n>event</span><span class=o>,</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>exportedPost</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>isPostEnd</span><span class=o>(</span><span class=n>event</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>postRead</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>exportedPost</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>isPostEnd</span><span class=o>(</span><span class=n>XMLEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>event</span><span class=o>.</span><span class=na>isEndElement</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=s>&#34;item&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>asEndElement</span><span class=o>().</span><span class=na>getName</span><span class=o>().</span><span class=na>getPrefix</span><span class=o>()</span> <span class=o>+</span> <span class=n>event</span><span class=o>.</span><span class=na>asEndElement</span><span class=o>().</span><span class=na>getName</span><span class=o>().</span><span class=na>getLocalPart</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>isPostStart</span><span class=o>(</span><span class=n>XMLEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>event</span><span class=o>.</span><span class=na>isStartElement</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=s>&#34;item&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>getEventFullName</span><span class=o>(</span><span class=n>event</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Post</span> <span class=nf>loadPostFromEvent</span><span class=o>(</span><span class=n>XMLEvent</span> <span class=n>event</span><span class=o>,</span> <span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>Post</span> <span class=n>post</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>name</span> <span class=o>=</span> <span class=n>getEventFullName</span><span class=o>(</span><span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>switch</span> <span class=o>(</span><span class=n>name</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=s>&#34;title&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>post</span> <span class=o>=</span> <span class=n>loadTitle</span><span class=o>(</span><span class=n>eventReader</span><span class=o>,</span> <span class=n>post</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=s>&#34;pubDate&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>post</span> <span class=o>=</span> <span class=n>loadPublishingDate</span><span class=o>(</span><span class=n>eventReader</span><span class=o>,</span> <span class=n>post</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=s>&#34;category&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=o>(</span><span class=n>isTag</span><span class=o>(</span><span class=n>event</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>post</span> <span class=o>=</span> <span class=n>loadCategory</span><span class=o>(</span><span class=n>eventReader</span><span class=o>,</span> <span class=n>event</span><span class=o>,</span> <span class=n>post</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=s>&#34;contentencoded&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>post</span> <span class=o>=</span> <span class=n>loadContent</span><span class=o>(</span><span class=n>eventReader</span><span class=o>,</span> <span class=n>post</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>                <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>XMLStreamException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Error parsing &#34;</span> <span class=o>+</span> <span class=n>name</span> <span class=o>+</span> <span class=s>&#34;: &#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>post</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Post</span> <span class=nf>loadContent</span><span class=o>(</span><span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>Post</span> <span class=n>post</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>post</span><span class=o>.</span><span class=na>withContent</span><span class=o>(</span><span class=n>eventReader</span><span class=o>.</span><span class=na>nextEvent</span><span class=o>().</span><span class=na>asCharacters</span><span class=o>().</span><span class=na>getData</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Post</span> <span class=nf>loadCategory</span><span class=o>(</span><span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>XMLEvent</span> <span class=n>event</span><span class=o>,</span> <span class=n>Post</span> <span class=n>post</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>post</span><span class=o>.</span><span class=na>withTag</span><span class=o>(</span><span class=n>eventReader</span><span class=o>.</span><span class=na>nextEvent</span><span class=o>().</span><span class=na>asCharacters</span><span class=o>().</span><span class=na>getData</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Post</span> <span class=nf>loadPublishingDate</span><span class=o>(</span><span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>Post</span> <span class=n>post</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>post</span><span class=o>.</span><span class=na>withPublishingDate</span><span class=o>(</span><span class=n>parsePubDate</span><span class=o>(</span><span class=n>eventReader</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Post</span> <span class=nf>loadTitle</span><span class=o>(</span><span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>Post</span> <span class=n>post</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>post</span><span class=o>.</span><span class=na>withTitle</span><span class=o>(</span><span class=n>eventReader</span><span class=o>.</span><span class=na>nextEvent</span><span class=o>().</span><span class=na>asCharacters</span><span class=o>().</span><span class=na>getData</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=nf>getEventFullName</span><span class=o>(</span><span class=n>XMLEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>event</span><span class=o>.</span><span class=na>asStartElement</span><span class=o>().</span><span class=na>getName</span><span class=o>().</span><span class=na>getPrefix</span><span class=o>()</span> <span class=o>+</span> <span class=n>event</span><span class=o>.</span><span class=na>asStartElement</span><span class=o>().</span><span class=na>getName</span><span class=o>().</span><span class=na>getLocalPart</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>isTag</span><span class=o>(</span><span class=n>XMLEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s>&#34;post_tag&#34;</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>asStartElement</span><span class=o>().</span><span class=na>getAttributeByName</span><span class=o>(</span><span class=k>new</span> <span class=n>QName</span><span class=o>(</span><span class=s>&#34;domain&#34;</span><span class=o>)).</span><span class=na>getValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Date</span> <span class=nf>parsePubDate</span><span class=o>(</span><span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Date</span> <span class=n>publishingDate</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>pubDate</span> <span class=o>=</span> <span class=n>eventReader</span><span class=o>.</span><span class=na>nextEvent</span><span class=o>().</span><span class=na>asCharacters</span><span class=o>().</span><span class=na>getData</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>pubDate</span> <span class=o>=</span> <span class=n>extractDate</span><span class=o>(</span><span class=n>pubDate</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>SimpleDateFormat</span> <span class=n>format</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SimpleDateFormat</span><span class=o>(</span><span class=s>&#34;dd MMM yyyy&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>publishingDate</span> <span class=o>=</span> <span class=n>format</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>pubDate</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ParseException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Could not parse pubDate: &#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>publishingDate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=nf>extractDate</span><span class=o>(</span><span class=n>String</span> <span class=n>pubDate</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//Date is supplied as this: Wed, 30 Nov -0001 00:00:00 +0000, we need to extract just the date
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pubDate</span> <span class=o>=</span> <span class=n>pubDate</span><span class=o>.</span><span class=na>substring</span><span class=o>(</span><span class=n>pubDate</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=s>&#34;,&#34;</span><span class=o>)+</span><span class=n>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>hourIndex</span> <span class=o>=</span> <span class=n>pubDate</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=s>&#34;:&#34;</span><span class=o>)-</span><span class=n>3</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>pubDate</span> <span class=o>=</span> <span class=n>pubDate</span><span class=o>.</span><span class=na>substring</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>hourIndex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>pubDate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>XMLEventReader</span> <span class=nf>getEventReader</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>XMLInputFactory</span> <span class=n>inputFactory</span> <span class=o>=</span> <span class=n>XMLInputFactory</span><span class=o>.</span><span class=na>newInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>InputStream</span> <span class=n>in</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>XMLEventReader</span> <span class=n>eventReader</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>in</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileInputStream</span><span class=o>(</span><span class=n>origin</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>eventReader</span> <span class=o>=</span> <span class=n>inputFactory</span><span class=o>.</span><span class=na>createXMLEventReader</span><span class=o>(</span><span class=n>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>FileNotFoundException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Could not find origin file: &#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>XMLStreamException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Could not read origin file: &#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>eventReader</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>existsOrigin</span><span class=o>(</span><span class=n>String</span> <span class=n>origin</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>File</span> <span class=n>originFile</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>origin</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>path</span> <span class=o>=</span> <span class=n>originFile</span><span class=o>.</span><span class=na>getAbsolutePath</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>originFile</span><span class=o>.</span><span class=na>exists</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></div><p>Lo del parseo de la fecha ha sido un espectáculo&mldr; no he sido capaz de sacarlo con el DateFormatter para convertirlo a un LocalDate.
Bueno, pues ahora que lo tengo&mldr; ¿no tendría más sentido que todo eso fuera a una clase propia? Digamos WpReader. Pues sí, porque ahora mismo mi clase principal se esta responsabilizando de saber como se leen los posts y qué hacer con los posts leidos, así que es mucho más claro hacerlo con una colaboradora.
Pero claro, si me llevo la lógica aparte, ¿cómo aviso de que se puede escribir un nuevo post sin romper el while que itera sobre todos los elementos del XML?
Bueno, pues finamente diría que voy a usar un patrón observador, para notificar de cuando hay un nuevo post. Técnicamente lo que voy a hacer es implementar un callback y así <em>Wp2JBake</em> queda mucho más clara:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Wp2JBake</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>WpReader</span> <span class=n>wpReader</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>MdWriter</span> <span class=n>mdWriter</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>HashSet</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=n>exportResult</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Wp2JBake</span><span class=o>(</span><span class=n>String</span> <span class=n>origin</span><span class=o>,</span> <span class=n>String</span> <span class=n>destination</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>wpReader</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WpReader</span><span class=o>(</span><span class=n>origin</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>mdWriter</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MdWriter</span><span class=o>(</span><span class=n>destination</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=nf>generateJBakeMarkdown</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>exportResult</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=n>wpReader</span><span class=o>.</span><span class=na>readPosts</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>exportResult</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>postRead</span><span class=o>(</span><span class=n>Post</span> <span class=n>post</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>exportResult</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>mdWriter</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>post</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Y por otro lado tenemos <em>WpReader</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>WpReader</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>ITEM</span> <span class=o>=</span> <span class=s>&#34;item&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>TITLE</span> <span class=o>=</span> <span class=s>&#34;title&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>PUB_DATE</span> <span class=o>=</span> <span class=s>&#34;pubDate&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>CATEGORY</span> <span class=o>=</span> <span class=s>&#34;category&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>CONTENT</span> <span class=o>=</span> <span class=s>&#34;contentencoded&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>POST_TAG</span> <span class=o>=</span> <span class=s>&#34;post_tag&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>DOMAIN</span> <span class=o>=</span> <span class=s>&#34;domain&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>origin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>WpReader</span><span class=o>(</span><span class=n>String</span> <span class=n>origin</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=n>origin</span><span class=o>)</span> <span class=o>||</span> <span class=o>!</span><span class=n>existsOrigin</span><span class=o>(</span><span class=n>origin</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Origin is not a valid file&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>origin</span> <span class=o>=</span> <span class=n>origin</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>existsOrigin</span><span class=o>(</span><span class=n>String</span> <span class=n>origin</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>File</span> <span class=n>originFile</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>origin</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>originFile</span><span class=o>.</span><span class=na>exists</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>readPosts</span><span class=o>(</span><span class=n>Wp2JBake</span> <span class=n>wp2JBake</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>XMLEventReader</span> <span class=n>eventReader</span> <span class=o>=</span> <span class=n>getEventReader</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>readXML</span><span class=o>(</span><span class=n>wp2JBake</span><span class=o>,</span> <span class=n>eventReader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>XMLStreamException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Error reading XML &#34;</span> <span class=o>+</span> <span class=n>origin</span> <span class=o>+</span> <span class=s>&#34;: &#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>readXML</span><span class=o>(</span><span class=n>Wp2JBake</span> <span class=n>wp2JBake</span><span class=o>,</span> <span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=n>eventReader</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>readElement</span><span class=o>(</span><span class=n>wp2JBake</span><span class=o>,</span> <span class=n>eventReader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>readElement</span><span class=o>(</span><span class=n>Wp2JBake</span> <span class=n>wp2JBake</span><span class=o>,</span> <span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>XMLEvent</span> <span class=n>event</span> <span class=o>=</span> <span class=n>eventReader</span><span class=o>.</span><span class=na>nextEvent</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>isPostStart</span><span class=o>(</span><span class=n>event</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Post</span> <span class=n>post</span> <span class=o>=</span> <span class=n>readPost</span><span class=o>(</span><span class=n>eventReader</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>wp2JBake</span><span class=o>.</span><span class=na>postRead</span><span class=o>(</span><span class=n>post</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Post</span> <span class=nf>readPost</span><span class=o>(</span><span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Post</span> <span class=n>exportedPost</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Post</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>boolean</span> <span class=n>postRead</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(!</span><span class=n>postRead</span> <span class=o>&amp;&amp;</span> <span class=n>eventReader</span><span class=o>.</span><span class=na>hasNext</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>XMLEvent</span> <span class=n>event</span> <span class=o>=</span> <span class=n>eventReader</span><span class=o>.</span><span class=na>nextEvent</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>isStartElement</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>exportedPost</span> <span class=o>=</span> <span class=n>loadAttribute</span><span class=o>(</span><span class=n>event</span><span class=o>,</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>exportedPost</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>isPostEnd</span><span class=o>(</span><span class=n>event</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>postRead</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>exportedPost</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>isPostEnd</span><span class=o>(</span><span class=n>XMLEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>event</span><span class=o>.</span><span class=na>isEndElement</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>ITEM</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>asEndElement</span><span class=o>().</span><span class=na>getName</span><span class=o>().</span><span class=na>getPrefix</span><span class=o>()</span> <span class=o>+</span> <span class=n>event</span><span class=o>.</span><span class=na>asEndElement</span><span class=o>().</span><span class=na>getName</span><span class=o>().</span><span class=na>getLocalPart</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Post</span> <span class=nf>loadAttribute</span><span class=o>(</span><span class=n>XMLEvent</span> <span class=n>event</span><span class=o>,</span> <span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>Post</span> <span class=n>post</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>name</span> <span class=o>=</span> <span class=n>getEventFullName</span><span class=o>(</span><span class=n>event</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>post</span> <span class=o>=</span> <span class=n>loadAttribute</span><span class=o>(</span><span class=n>event</span><span class=o>,</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>post</span><span class=o>,</span> <span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>XMLStreamException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Error parsing &#34;</span> <span class=o>+</span> <span class=n>name</span> <span class=o>+</span> <span class=s>&#34;: &#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>post</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Post</span> <span class=nf>loadAttribute</span><span class=o>(</span><span class=n>XMLEvent</span> <span class=n>event</span><span class=o>,</span> <span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>Post</span> <span class=n>post</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=o>(</span><span class=n>name</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>TITLE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=n>post</span> <span class=o>=</span> <span class=n>loadTitle</span><span class=o>(</span><span class=n>eventReader</span><span class=o>,</span> <span class=n>post</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>PUB_DATE</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=n>post</span> <span class=o>=</span> <span class=n>loadPublishingDate</span><span class=o>(</span><span class=n>eventReader</span><span class=o>,</span> <span class=n>post</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>CATEGORY</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>isTag</span><span class=o>(</span><span class=n>event</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>post</span> <span class=o>=</span> <span class=n>loadCategory</span><span class=o>(</span><span class=n>eventReader</span><span class=o>,</span> <span class=n>post</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>CONTENT</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=n>post</span> <span class=o>=</span> <span class=n>loadContent</span><span class=o>(</span><span class=n>eventReader</span><span class=o>,</span> <span class=n>post</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>post</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Post</span> <span class=nf>loadContent</span><span class=o>(</span><span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>Post</span> <span class=n>post</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>post</span><span class=o>.</span><span class=na>withContent</span><span class=o>(</span><span class=n>eventReader</span><span class=o>.</span><span class=na>nextEvent</span><span class=o>().</span><span class=na>asCharacters</span><span class=o>().</span><span class=na>getData</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Post</span> <span class=nf>loadCategory</span><span class=o>(</span><span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>Post</span> <span class=n>post</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>post</span><span class=o>.</span><span class=na>withTag</span><span class=o>(</span><span class=n>eventReader</span><span class=o>.</span><span class=na>nextEvent</span><span class=o>().</span><span class=na>asCharacters</span><span class=o>().</span><span class=na>getData</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Post</span> <span class=nf>loadPublishingDate</span><span class=o>(</span><span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>Post</span> <span class=n>post</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>post</span><span class=o>.</span><span class=na>withPublishingDate</span><span class=o>(</span><span class=n>parsePubDate</span><span class=o>(</span><span class=n>eventReader</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Post</span> <span class=nf>loadTitle</span><span class=o>(</span><span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>,</span> <span class=n>Post</span> <span class=n>post</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>post</span><span class=o>.</span><span class=na>withTitle</span><span class=o>(</span><span class=n>eventReader</span><span class=o>.</span><span class=na>nextEvent</span><span class=o>().</span><span class=na>asCharacters</span><span class=o>().</span><span class=na>getData</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>isTag</span><span class=o>(</span><span class=n>XMLEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>POST_TAG</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>asStartElement</span><span class=o>().</span><span class=na>getAttributeByName</span><span class=o>(</span><span class=k>new</span> <span class=n>QName</span><span class=o>(</span><span class=n>DOMAIN</span><span class=o>)).</span><span class=na>getValue</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Date</span> <span class=nf>parsePubDate</span><span class=o>(</span><span class=n>XMLEventReader</span> <span class=n>eventReader</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>XMLStreamException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Date</span> <span class=n>publishingDate</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>pubDate</span> <span class=o>=</span> <span class=n>eventReader</span><span class=o>.</span><span class=na>nextEvent</span><span class=o>().</span><span class=na>asCharacters</span><span class=o>().</span><span class=na>getData</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>pubDate</span> <span class=o>=</span> <span class=n>extractDate</span><span class=o>(</span><span class=n>pubDate</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>SimpleDateFormat</span> <span class=n>format</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SimpleDateFormat</span><span class=o>(</span><span class=s>&#34;dd MMM yyyy&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>publishingDate</span> <span class=o>=</span> <span class=n>format</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>pubDate</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ParseException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Could not parse pubDate: &#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>publishingDate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=nf>extractDate</span><span class=o>(</span><span class=n>String</span> <span class=n>pubDate</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//Date is supplied as this: Wed, 30 Nov -0001 00:00:00 +0000 (RFC822 presumably), we need to extract just the date
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>pubDate</span> <span class=o>=</span> <span class=n>pubDate</span><span class=o>.</span><span class=na>substring</span><span class=o>(</span><span class=n>pubDate</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=s>&#34;,&#34;</span><span class=o>)+</span><span class=n>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>hourIndex</span> <span class=o>=</span> <span class=n>pubDate</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=s>&#34;:&#34;</span><span class=o>)-</span><span class=n>3</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>pubDate</span> <span class=o>=</span> <span class=n>pubDate</span><span class=o>.</span><span class=na>substring</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>hourIndex</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>pubDate</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>isPostStart</span><span class=o>(</span><span class=n>XMLEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>event</span><span class=o>.</span><span class=na>isStartElement</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>ITEM</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>getEventFullName</span><span class=o>(</span><span class=n>event</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=nf>getEventFullName</span><span class=o>(</span><span class=n>XMLEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>event</span><span class=o>.</span><span class=na>asStartElement</span><span class=o>().</span><span class=na>getName</span><span class=o>().</span><span class=na>getPrefix</span><span class=o>()</span> <span class=o>+</span> <span class=n>event</span><span class=o>.</span><span class=na>asStartElement</span><span class=o>().</span><span class=na>getName</span><span class=o>().</span><span class=na>getLocalPart</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>XMLEventReader</span> <span class=nf>getEventReader</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>XMLInputFactory</span> <span class=n>inputFactory</span> <span class=o>=</span> <span class=n>XMLInputFactory</span><span class=o>.</span><span class=na>newInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>InputStream</span> <span class=n>in</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>XMLEventReader</span> <span class=n>eventReader</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>in</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileInputStream</span><span class=o>(</span><span class=n>origin</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>eventReader</span> <span class=o>=</span> <span class=n>inputFactory</span><span class=o>.</span><span class=na>createXMLEventReader</span><span class=o>(</span><span class=n>in</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>FileNotFoundException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Could not find origin file: &#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>XMLStreamException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span><span class=s>&#34;Could not read origin file: &#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>eventReader</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Pues para terminar con esta sección que se ha alargado más de lo que esperaba, me queda modificar los tests:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RunWith</span><span class=o>(</span><span class=n>MockitoJUnitRunner</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>WpReaderTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>WpReader</span> <span class=n>sut</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Mock</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Wp2JBake</span> <span class=n>observer</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span><span class=o>(</span><span class=n>expected</span> <span class=o>=</span> <span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>readerWithoutOrigin</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WpReader</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span><span class=o>(</span><span class=n>expected</span> <span class=o>=</span> <span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>readerWithEmptyOrigin</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WpReader</span><span class=o>(</span><span class=s>&#34;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span><span class=o>(</span><span class=n>expected</span> <span class=o>=</span> <span class=n>IllegalArgumentException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>buildWithInvalidOrigin</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WpReader</span><span class=o>(</span><span class=s>&#34;foo&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span><span class=o>(</span><span class=n>expected</span> <span class=o>=</span> <span class=n>IllegalStateException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>readEmptyXML</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WpReader</span><span class=o>(</span><span class=s>&#34;src/test/resources/empty.xml&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span><span class=o>.</span><span class=na>readPosts</span><span class=o>(</span><span class=n>observer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span><span class=o>(</span><span class=n>expected</span> <span class=o>=</span> <span class=n>IllegalStateException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>readInvalidXML</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WpReader</span><span class=o>(</span><span class=s>&#34;src/test/resources/invalid.xml&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span><span class=o>.</span><span class=na>readPosts</span><span class=o>(</span><span class=n>observer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>readValidXML</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WpReader</span><span class=o>(</span><span class=s>&#34;src/test/resources/wp-source.xml&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ArgumentCaptor</span><span class=o>&lt;</span><span class=n>Post</span><span class=o>&gt;</span> <span class=n>postCapturer</span> <span class=o>=</span> <span class=n>ArgumentCaptor</span><span class=o>.</span><span class=na>forClass</span><span class=o>(</span><span class=n>Post</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sut</span><span class=o>.</span><span class=na>readPosts</span><span class=o>(</span><span class=n>observer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>verify</span><span class=o>(</span><span class=n>observer</span><span class=o>,</span> <span class=n>times</span><span class=o>(</span><span class=n>7</span><span class=o>)).</span><span class=na>postRead</span><span class=o>(</span><span class=n>postCapturer</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Con esto ya ha quedado perfecto, si no tanto el software, si los tests. Cada clase tiene una responsabilidad bien definida y así se refleja en los tests. Eso sí, en esta última clase he tenido que meter Mockito para simular el <em>Wp2JBake</em> que me hace falta para el callback. Lo bueno de esto es que con Mockito puedo verificar las llamadas a los métodos y por primera vez tengo todos los tests en verde.
Eso sí, los tests de <em>Wp2JBake</em> se han quedado en realidad como pruebas de integración, así que no me preocupa que el test original siga en rojo porque realmente hasta que no este implementada la escritura no debería pasar a verde :).</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.aguasnegras.es/tags/java/>Java</a></li><li><a href=https://www.aguasnegras.es/tags/jbake/>JBake</a></li><li><a href=https://www.aguasnegras.es/tags/wordpress/>WordPress</a></li></ul><nav class=paginav><a class=prev href=https://www.aguasnegras.es/posts/2016/05/30-springdevtoolsintellij/><span class=title>« Prev</span><br><span>Spring Boot Developer Tools e Intellij IDEA</span></a>
<a class=next href=https://www.aguasnegras.es/posts/2016/02/04-wp2jbake-inicio/><span class=title>Next »</span><br><span>Wordpress to JBake - Inicio</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Wordpress to JBake - Parseo on twitter" href="https://twitter.com/intent/tweet/?text=Wordpress%20to%20JBake%20-%20Parseo&url=https%3a%2f%2fwww.aguasnegras.es%2fposts%2f2016%2f03%2f20-wp2jbake-parseo%2f&hashtags=Java%2cJBake%2cWordpress"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Wordpress to JBake - Parseo on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.aguasnegras.es%2fposts%2f2016%2f03%2f20-wp2jbake-parseo%2f&title=Wordpress%20to%20JBake%20-%20Parseo&summary=Wordpress%20to%20JBake%20-%20Parseo&source=https%3a%2f%2fwww.aguasnegras.es%2fposts%2f2016%2f03%2f20-wp2jbake-parseo%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Wordpress to JBake - Parseo on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.aguasnegras.es%2fposts%2f2016%2f03%2f20-wp2jbake-parseo%2f&title=Wordpress%20to%20JBake%20-%20Parseo"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Wordpress to JBake - Parseo on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.aguasnegras.es%2fposts%2f2016%2f03%2f20-wp2jbake-parseo%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Wordpress to JBake - Parseo on whatsapp" href="https://api.whatsapp.com/send?text=Wordpress%20to%20JBake%20-%20Parseo%20-%20https%3a%2f%2fwww.aguasnegras.es%2fposts%2f2016%2f03%2f20-wp2jbake-parseo%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Wordpress to JBake - Parseo on telegram" href="https://telegram.me/share/url?text=Wordpress%20to%20JBake%20-%20Parseo&url=https%3a%2f%2fwww.aguasnegras.es%2fposts%2f2016%2f03%2f20-wp2jbake-parseo%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://www.aguasnegras.es/>AguasNegras</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>